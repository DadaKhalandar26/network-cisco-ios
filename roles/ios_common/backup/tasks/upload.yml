---
# ============================================================
# Upload Cisco IOS backup to SFTP server
# - Tries key-based SSH first
# - Falls back to password using expect
# ============================================================

- name: Check if remote backup directory exists (key-based SSH)
  ansible.builtin.command: >
    sftp -o BatchMode=yes
        -o StrictHostKeyChecking=no
        -o UserKnownHostsFile=/dev/null
        {{ sftp_username }}@{{ sftp_host }}
        "test -d /backups/{{ inventory_hostname }} && echo present || echo missing"
  delegate_to: "{{ sftp_delegate | default('localhost') }}"
  register: remote_dir_check
  changed_when: false
  failed_when: false

- name: Create remote backup directory using password SSH (expect) if missing
  ansible.builtin.expect:
    command: >
      sftp -o StrictHostKeyChecking=no
          -o UserKnownHostsFile=/dev/null
          {{ sftp_username }}@{{ sftp_host }}
          "mkdir /backups/{{ inventory_hostname }}"
    responses:
      (?i)password: "{{ sftp_password }}"
  delegate_to: "{{ sftp_delegate | default('localhost') }}"
  when: remote_dir_check.stdout is defined and
        remote_dir_check.stdout.find('present') == -1
  register: mkdir_expect_result
  failed_when: mkdir_expect_result.rc != 0

- name: Re-check remote backup directory exists
  ansible.builtin.command: >
    sftp -o BatchMode=yes
        -o StrictHostKeyChecking=no
        -o UserKnownHostsFile=/dev/null
        {{ sftp_username }}@{{ sftp_host }}
        "test -d /backups/{{ inventory_hostname }} && echo present || echo missing"
  delegate_to: "{{ sftp_delegate | default('localhost') }}"
  register: remote_dir_check_final
  changed_when: false
  failed_when: false

- name: Fail if remote backup directory still missing
  ansible.builtin.fail:
    msg: >
      Remote directory /backups/{{ inventory_hostname }}/
      does not exist and could not be created on {{ sftp_host }}
  when: remote_dir_check_final.stdout is defined and
        remote_dir_check_final.stdout.find('present') == -1

- name: Upload config backup to SFTP server using password (expect)
  ansible.builtin.expect:
    command: >
      sftp -o StrictHostKeyChecking=no
           -o UserKnownHostsFile=/dev/null
           {{ sftp_username }}@{{ sftp_host }}:/backups/{{ inventory_hostname }}/
    responses:
      (?i)password: "{{ sftp_password }}"
      sftp>:
        - "put {{ backup_result.backup_path }}"
        - "bye"
  delegate_to: "{{ sftp_delegate | default('localhost') }}"
  register: sftp_expect_result
  failed_when: sftp_expect_result.rc != 0
