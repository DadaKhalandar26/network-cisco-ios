---
- name: Verify SFTP upload result (expect returned OK)
  ansible.builtin.debug:
    msg: "SFTP upload stdout: {{ sftp_expect_result.stdout_lines | default([]) }}"

- name: Optionally check remote file exists via sftp (best-effort)
  ansible.builtin.shell: >
    sftp -o StrictHostKeyChecking=no
        -o UserKnownHostsFile=/dev/null
        {{ sftp_username }}@{{ sftp_host }}
        "ls /ios/backups/{{ inventory_hostname }}/{{ backup_result.backup_path | basename }} && echo present || echo missing"
  delegate_to: localhost
  register: remote_check
  changed_when: false
  failed_when: false

- name: Fail if remote file missing (optional)
  ansible.builtin.fail:
    msg: "Uploaded backup not found on SFTP server"
  when: remote_check.stdout is defined and ('present' not in remote_check.stdout)
