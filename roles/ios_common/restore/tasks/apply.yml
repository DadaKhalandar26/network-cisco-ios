---
# ============================================================
# STEP 1 — Copy backup file into Nginx HTTPS directory
# ============================================================
- name: Ensure Nginx HTTPS directory exists
  ansible.builtin.file:
    path: /tmp/backups
    state: directory
    mode: '0755'
  delegate_to: localhost

- name: Place backup file in HTTPS directory
  ansible.builtin.copy:
    src: "{{ backup_full_path }}"
    dest: "/tmp/backups/{{ backup_filename }}"
  delegate_to: localhost

# ============================================================
# STEP 2 — Device pulls file via HTTPS (non-interactive)
# ============================================================
- name: Copy backup file to device flash using HTTPS
  cisco.ios.ios_command:
    commands:
      - "copy https://{{ controller_ip }}/backups/{{ backup_filename }} bootflash:{{ backup_filename }} /noverify /quiet"
  vars:
    ansible_command_timeout: 300
  register: https_copy

- debug:
    var: https_copy.stdout_lines

# ============================================================
# STEP 3 — Verify file exists on flash
# ============================================================
- name: Verify uploaded file exists
  cisco.ios.ios_command:
    commands:
      - "dir bootflash: | include {{ backup_filename }}"
  register: flash_check

- name: Fail if file not found on flash
  fail:
    msg: "Backup file {{ backup_filename }} not found on device bootflash!"
  when: flash_check.stdout[0] is not search(backup_filename)

# ============================================================
# STEP 4 — Restore configuration using configure replace
# ============================================================
- name: Restore config using configure replace
  cisco.ios.ios_command:
    commands:
      - "configure replace bootflash:{{ backup_filename }} force"
  register: restore_output

- debug:
    var: restore_output.stdout_lines
