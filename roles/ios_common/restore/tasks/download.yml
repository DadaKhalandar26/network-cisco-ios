---
- name: List backup files on SFTP server
  ansible.builtin.expect:
    command: >
      sftp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
      {{ sftp_username }}@{{ sftp_host }}:/ios/backups/
    responses:
      (?i)password: "{{ sftp_password }}"
      sftp>:
        - "cd /ios/backups/"
        - "ls"
        - "bye"
  register: sftp_list
  delegate_to: localhost

- name: Keep only lines that end with .cfg
  set_fact:
    sftp_cfg_lines: "{{ sftp_list.stdout_lines | select('search','\\.cfg$') | list }}"

- name: Flatten multi-column ls output into individual filenames
  set_fact:
    sftp_cfg_files: "{{ (sftp_cfg_lines | map('split') | list | sum(start=[]) | map('trim') | reject('equalto','') | list) }}"

- name: Build normalized file objects
  set_fact:
    sftp_norm_files: "{{ sftp_norm_files | default([]) + [ {'orig': item, 'norm': (item | regex_replace('[^A-Za-z0-9]','') | lower)} ] }}"
  loop: "{{ sftp_cfg_files }}"
  loop_control:
    label: "{{ item }}"

- name: Normalize inventory hostname
  set_fact:
    host_norm: "{{ inventory_hostname | regex_replace('[^A-Za-z0-9]','') | lower }}"

- name: Find files whose normalized name contains normalized hostname
  set_fact:
    matching_files: >-
      {{
        (sftp_norm_files
         | selectattr('norm','search', host_norm)
         | map(attribute='orig')
         | list)
      }}

- name: Select latest backup (hostname match first, fallback to most recent overall)
  set_fact:
    latest_backup: >-
      {{
        (
          (matching_files | sort | last)
          if (matching_files | length) > 0
          else (sftp_cfg_files | sort | last | default(''))
        )
      }}

- name: Fail if no backup exists
  fail:
    msg: "No backup found for {{ inventory_hostname }} on SFTP server; sftp_cfg_files={{ sftp_cfg_files }}"
  when: latest_backup == ""

- name: Download latest backup file
  ansible.builtin.expect:
    command: >
      sftp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
      {{ sftp_username }}@{{ sftp_host }}:/ios/backups/
    responses:
      (?i)password: "{{ sftp_password }}"
      sftp>:
        - "get {{ latest_backup }} {{ download_dest_dir | default('/tmp') }}/{{ latest_backup }}"
        - "bye"
  delegate_to: localhost

- name: Confirm file exists on controller
  stat:
    path: "{{ download_dest_dir | default('/tmp') }}/{{ latest_backup }}"
  register: downloaded_stat
  delegate_to: localhost

- name: Debug selected backup and download result
  debug:
    msg:
      - "selected_backup={{ latest_backup }}"
      - "downloaded={{ downloaded_stat.stat.exists | default(false) }}"
      - "path={{ download_dest_dir | default('/tmp') }}/{{ latest_backup }}"
  when: downloaded_stat is defined
