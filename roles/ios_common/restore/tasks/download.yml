---
- name: Ensure download directory exists on controller
  file:
    path: "{{ download_dest_dir | default('/tmp') }}"
    state: directory
    mode: "01777"
  delegate_to: localhost

# ---------------------------------------------------------
# STEP 1 — LIST FILES (AWX-SAFE, NO HEREDOC)
# ---------------------------------------------------------

- name: List backup files on SFTP server (AWX-safe, no heredoc)
  ansible.builtin.shell: >
    printf "cd {{ sftp_path | default('/ios/backups/') }}\nls -1\nbye\n" |
    sshpass -p '{{ sftp_password }}' sftp
    -oBatchMode=no
    -oStrictHostKeyChecking=no
    -oUserKnownHostsFile=/dev/null
    {{ sftp_username }}@{{ sftp_host }}
  register: sftp_list
  delegate_to: localhost
  changed_when: false

- name: Debug raw SFTP output
  debug:
    var: sftp_list.stdout_lines

# ---------------------------------------------------------
# STEP 2 — NORMALIZE OUTPUT
# ---------------------------------------------------------

- name: Flatten stdout_lines into clean list
  set_fact:
    sftp_raw_lines: "{{ sftp_list.stdout_lines | default([]) | list }}"

- name: Clean tokens (handles multi-column ls)
  set_fact:
    sftp_tokens: >-
      {{ (sftp_raw_lines
          | map('split')
          | list
          | sum(start=[])
          | map('trim')
          | reject('equalto','')
          | list) }}

- name: Keep only .cfg files
  set_fact:
    sftp_cfg_files: "{{ sftp_tokens | select('search','\\.cfg$') | list }}"

- name: Debug tokens and cfg files
  debug:
    msg:
      - "raw_lines={{ sftp_raw_lines }}"
      - "tokens={{ sftp_tokens }}"
      - "cfg_files={{ sftp_cfg_files }}"

# ---------------------------------------------------------
# STEP 3 — RELAXED, CASE-INSENSITIVE HOST FILTERING
# ---------------------------------------------------------

- name: Normalize hostname (strip FQDN)
  set_fact:
    host_prefix: "{{ inventory_hostname.split('.')[0] }}"

- name: Find files that belong to this host (case-insensitive)
  set_fact:
    matching_files: >-
      {{ sftp_cfg_files
         | select('search',
                  '(?i)^' ~ host_prefix ~ '-[0-9]{8}-[0-9]{6}\\.cfg$')
         | list }}

- name: Debug matching files
  debug:
    msg:
      - "Host prefix={{ host_prefix }}"
      - "Matching files={{ matching_files }}"

- name: Fail if no backup exists
  fail:
    msg: "No backup found for {{ inventory_hostname }} (prefix={{ host_prefix }}) on SFTP server."
  when: matching_files | length == 0

# ---------------------------------------------------------
# STEP 4 — SELECT LATEST BACKUP
# ---------------------------------------------------------

- name: Select latest backup
  set_fact:
    latest_backup: "{{ matching_files | sort | last }}"

- name: Debug selected backup
  debug:
    msg: "Selected latest backup: {{ latest_backup }}"

# ---------------------------------------------------------
# STEP 5 — DOWNLOAD THE FILE (NO HEREDOC)
# ---------------------------------------------------------

- name: Download latest backup file (AWX-safe, no heredoc)
  ansible.builtin.shell: >
    printf "cd {{ sftp_path | default('/ios/backups/') }}\nget {{ latest_backup }} {{ download_dest_dir | default('/tmp') }}/{{ latest_backup }}\nbye\n" |
    sshpass -p '{{ sftp_password }}' sftp
    -oBatchMode=no
    -oStrictHostKeyChecking=no
    -oUserKnownHostsFile=/dev/null
    {{ sftp_username }}@{{ sftp_host }}
  register: download_status
  delegate_to: localhost
  changed_when: "'Fetching' in download_status.stdout"

- name: Confirm file exists on controller
  stat:
    path: "{{ download_dest_dir | default('/tmp') }}/{{ latest_backup }}"
  register: downloaded_stat
  delegate_to: localhost

- name: Debug download result
  debug:
    msg:
      - "selected_backup={{ latest_backup }}"
      - "downloaded={{ downloaded_stat.stat.exists | default(false) }}"
      - "path={{ download_dest_dir | default('/tmp') }}/{{ latest_backup }}"
  when: downloaded_stat is defined
