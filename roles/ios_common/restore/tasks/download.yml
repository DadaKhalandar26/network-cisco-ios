---
- name: Ensure download directory exists on controller
  file:
    path: "{{ download_dest_dir | default('/tmp') }}"
    state: directory
    mode: "01777"
  delegate_to: localhost

- name: List backup files on SFTP server using single-column ls
  ansible.builtin.expect:
    command: >
      sftp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
      {{ sftp_username }}@{{ sftp_host }}:/ios/backups/
    responses:
      (?i)password: "{{ sftp_password }}"
      sftp>:
        - "ls -1"
        - "bye"
  register: sftp_list
  delegate_to: localhost

- name: If ls -1 returned nothing, fallback to plain ls
  when: (sftp_list.stdout | default('') | trim) == ''
  ansible.builtin.expect:
    command: >
      sftp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
      {{ sftp_username }}@{{ sftp_host }}:/ios/backups/
    responses:
      (?i)password: "{{ sftp_password }}"
      sftp>:
        - "ls"
        - "bye"
  register: sftp_list
  delegate_to: localhost

- name: Debug raw sftp stdout (string)
  debug:
    var: sftp_list.stdout

- name: Normalize stdout_lines structure (flatten nested lists)
  set_fact:
    sftp_raw_lines: "{{ (sftp_list.stdout_lines | default([]) | sum(start=[])) | list }}"

- name: Flatten lines into tokens (handles multi-column ls)
  set_fact:
    sftp_tokens: >-
      {{ (sftp_raw_lines
          | map('split')
          | list
          | sum(start=[])
          | map('trim')
          | reject('equalto','')
          | list) }}

- name: Keep only tokens that look like .cfg files
  set_fact:
    sftp_cfg_files: "{{ sftp_tokens | select('search','\\.cfg') | list }}"

- name: Debug tokens and cfg files
  debug:
    msg:
      - "raw_lines={{ sftp_raw_lines }}"
      - "tokens={{ sftp_tokens }}"
      - "cfg_files={{ sftp_cfg_files }}"

- name: Find files that contain the inventory hostname
  set_fact:
    matching_files: "{{ sftp_cfg_files | select('search', inventory_hostname) | list }}"

- name: Select latest backup (hostname match first, fallback to most recent overall)
  set_fact:
    latest_backup: >-
      {{ (matching_files | sort | last) if (matching_files | length) > 0 else (sftp_cfg_files | sort | last | default('')) }}

- name: Debug selected backup
  debug:
    msg: "Selected latest backup: {{ latest_backup }}"

- name: Fail if no backup exists
  fail:
    msg: "No backup found for {{ inventory_hostname }} on SFTP server; sftp_cfg_files={{ sftp_cfg_files }}"
  when: latest_backup == ""

- name: Download latest backup file
  ansible.builtin.expect:
    command: >
      sftp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
      {{ sftp_username }}@{{ sftp_host }}:/ios/backups/
    responses:
      (?i)password: "{{ sftp_password }}"
      sftp>:
        - "get {{ latest_backup }} {{ download_dest_dir | default('/tmp') }}/{{ latest_backup }}"
        - "bye"
  delegate_to: localhost

- name: Confirm file exists on controller
  stat:
    path: "{{ download_dest_dir | default('/tmp') }}/{{ latest_backup }}"
  register: downloaded_stat
  delegate_to: localhost

- name: Debug download result
  debug:
    msg:
      - "selected_backup={{ latest_backup }}"
      - "downloaded={{ downloaded_stat.stat.exists | default(false) }}"
      - "path={{ download_dest_dir | default('/tmp') }}/{{ latest_backup }}"
  when: downloaded_stat is defined
