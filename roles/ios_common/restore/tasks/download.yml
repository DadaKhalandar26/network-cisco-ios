# try pattern first
- name: List hostname-specific files on SFTP
  ansible.builtin.expect:
    command: >
      sftp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
      {{ sftp_username }}@{{ sftp_host }}
    responses:
      (?i)password: "{{ sftp_password }}"
      sftp>:
        - "cd /ios/backups/"
        - "ls {{ inventory_hostname }}*"
        - "bye"
  register: sftp_list
  delegate_to: localhost

# if no .cfg lines returned, fall back to full ls
- name: Fallback to full listing if pattern returned nothing
  set_fact:
    need_full_list: "{{ (sftp_list.stdout_lines | select('search','\\.cfg$') | list) | length == 0 }}"

- name: Full listing fallback
  when: need_full_list
  ansible.builtin.expect:
    command: >
      sftp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
      {{ sftp_username }}@{{ sftp_host }}
    responses:
      (?i)password: "{{ sftp_password }}"
      sftp>:
        - "cd /ios/backups/"
        - "ls"
        - "bye"
  register: sftp_list
  delegate_to: localhost

# normalize and split multi-column output, then filter .cfg and hostname
- name: Build file list
  set_fact:
    sftp_cfg_files: >-
      {{
        (sftp_list.stdout_lines
         | select('search','\\.cfg$')
         | map('split')
         | list
         | sum(start=[]))
      }}

- name: Select latest backup for this device
  set_fact:
    latest_backup: >-
      {{
        sftp_cfg_files
        | select('match', inventory_hostname)
        | sort
        | last
      }}
