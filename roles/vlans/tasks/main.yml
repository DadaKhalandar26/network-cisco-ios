---
#roles/vlan/tasks/main.yml
- name: Fail if vlans variable is not defined or empty
  fail:
    msg: "The 'vlans' variable is not defined or is empty. Define it in host_vars, group_vars, or pass it to the role."
  when: vlans is not defined or vlans | length == 0

- name: Render VLAN config locally using Jinja2
  template:
    src: "{{ template_file | default('vlans.j2') }}"
    dest: "/tmp/{{ inventory_hostname }}-vlans.cfg"
  delegate_to: localhost
  run_once: true

- name: Show rendered VLAN config
  debug:
    msg: "{{ lookup('file', '/tmp/' ~ inventory_hostname ~ '-vlans.cfg') }}"
  delegate_to: localhost
  run_once: true

# - name: Show backup path returned by module
#   debug:
#     var: ios_cfg_result.backup

# - name: Copy backup from controller to persistent location (example)
#   delegate_to: localhost
#   ansible.builtin.copy:
#     src: "{{ ios_cfg_result.backup }}"
#     dest: "/srv/ansible_backups/{{ inventory_hostname }}-{{ ansible_date_time.iso8601 }}.cfg"
#   when: ios_cfg_result.backup is defined


- name: Verify VLAN configuration (show vlan brief)
  cisco.ios.ios_command:
    commands:
      - show vlan brief
  register: vlan_show
  changed_when: false

- name: Display VLAN verification output
  ansible.builtin.debug:
    var: vlan_show.stdout_lines


- name: Render VLAN template to variable
  set_fact:
    vlans_cfg: "{{ lookup('template', 'vlans.j2') }}"
